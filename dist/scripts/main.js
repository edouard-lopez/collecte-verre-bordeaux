"use strict";var L,d3,sprintf,pavMap={map:null,DEFAULT:{mapCenter:new L.LatLng(44.8442,(-.5733)),mapZoom:15},STATE:{center:null,zoom:null},cluster:null,marker:null,markerList:{},adresses:null,onLocationError:function(t){alert(t.message)},onLocationFound:function(t,e){var a=t.accuracy/2;L.marker(t.latlng).addTo(e.map),L.circle(t.latlng,a,{color:"#3465a4",fillColor:"#729fcf"}).addTo(e.map)},highlightMarker:function(){var t=/pav=([\d\w]+)/,e=window.location.hash;if(""!==e&&null!==e){var a=t.exec(e)[1],o=sprintf('[alt="%s"]',a);$(o).attr("src","images/icon.active.png"),this.markerList[a].openPopup()}},setMapState:function(){this.STATE.center=this.DEFAULT.mapCenter,this.STATE.zoom=this.DEFAULT.mapZoom;var t=/c=(\-?\d+(\.\d+)?),\s*(\-?\d+(\.\d+)?)/,e=/z=(\d{1,2})/,a=window.location.hash;if(""!==a&&null!==a){var o=t.exec(a);if(this.STATE.zoom=e.exec(a)[1]||this.DEFAULT.mapZoom,null!==o){var n=o[1],r=o[3];3===o.length&&(n=o[1],r=o[2]),this.STATE.center=new L.LatLng(n,r)||this.DEFAULT.mapCenter}}return this.map.setView(this.STATE.center,this.STATE.zoom).locate({setView:!0,maxZoom:16}),this},getAdress:function(){var t=this;return new Promise(function(e,a){d3.json("scripts/location2adresses.json",function(o){t.adresses=o,null!==t.adresses?e(t):a(Error(o))})})},updatePopupZoomLevel:function(t){return function(){var e=$(".active-popup .share");if(e.length>0){var a=e.attr("href").replace(/z=(\d{1,2})/,"z="+t.map.getZoom());e.attr("href",a)}}},getPopupContent:function(t){return sprintf('<div class="active-popup">\t<h4>%s</h4>\t<p>partager: <a href="#c=%s&pav=%s&z=%d" target="_blank" class="share">%s <i class="fa fa-external-link"></i></a>\t<br/>\t<abbr title="référence">réf.</abbr>: <small>%s</small>\t</p></div>',t.label,t.latLng,t.id,t.zoom,t.latLng,t.id)},addItemToMap:function(){var t=this;return new Promise(function(e,a){d3.json("scripts/emplacements-pav.geo.json",function(o){L.geoJson(o,{pointToLayer:function(e,a){return L.marker(a,{icon:t.marker,alt:"<placeholder>"})},onEachFeature:function(e,a){var o=e.properties.IDENT;o=null!==o?o.replace(" ",""):o;var n=e.geometry.coordinates[0]+","+e.geometry.coordinates[1],r=n in t.adresses?t.adresses[n].split(", "):["rue inconnue."];r[0]="<b>"+r[0]+"</b>",r=r.join("<br/>");var i=a.getLatLng().lat+","+a.getLatLng().lng,s=t.map.getZoom()||t.DEFAULT.mapZoom,c={id:o,label:r,zoom:s,latLng:i},l=t.getPopupContent(c);a.options.alt=o,a.bindPopup(l,{className:"code"+o}).on("click",t.updatePopupZoomLevel(t),!1),t.markerList[o]=a}}).addTo(t.cluster),Object.keys(t.markerList).length>0?e(t):a(Error(o))})})},customizeMarker:function(){return this.marker=L.icon({iconUrl:"images/icon.png",shadowUrl:"images/icon.shadow.png",iconSize:[19,32],shadowSize:[29,32],iconAnchor:[8.5,32],shadowAnchor:[6,32],popupAnchor:[0,-28]}),this},attachTileLayer:function(){return new L.tileLayer("https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png",{id:"edouard-lopez.ik52o4kd",continuousWorld:!0,attribution:'© <a href="http://metadata.lacub.fr/geosource/apps/search/?uuid=1f8a4be0-900e-4eab-9dcf-55cd9f0a1aed">La CUB</a> | © <a href="http://www.openstreetmap.org/copyright"><abbr title="OpenStreetMap">OSM</abbr>, ODbL 1.0</a>'}).addTo(this.map),this},attachClusterLayer:function(){return this.cluster=new L.MarkerClusterGroup({showCoverageOnHover:!1,maxClusterRadius:80,disableClusteringAtZoom:16}).addTo(this.map),this},init:function(){this.map=L.map("map",{center:this.DEFAULT.center,zoom:this.DEFAULT.zoom,minZoom:0,maxZoom:18});var t=this;return this.map.on("locationfound",function(e){t.onLocationFound(e,t)}),this.map.on("locationerror",function(e){t.onLocationError(e,t)}),this}};!function(t,e,a){a.init().attachTileLayer().attachClusterLayer().customizeMarker().setMapState().getAdress().then(function(t){t.addItemToMap().then(function(t){t.highlightMarker()})}),a.map.on("zoomend",a.updatePopupZoomLevel(a))}(window,document,pavMap);